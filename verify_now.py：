```python
#!/usr/bin/env python3
"""
Xiongan Civilization OS - å³æ—¶éªŒè¯è„šæœ¬
éªŒè¯DIDæ¨¡å—å®Œå…¨åŠŸèƒ½
"""

import sys
import os

# æ·»åŠ é¡¹ç›®æ ¹ç›®å½•åˆ°Pythonè·¯å¾„
current_dir = os.path.dirname(os.path.abspath(__file__))
sys.path.insert(0, current_dir)

print("ğŸš€ Xiongan Civilization OS - å®Œæ•´åŠŸèƒ½éªŒè¯")
print("=" * 60)

def test_module_import():
    """æµ‹è¯•æ¨¡å—å¯¼å…¥"""
    try:
        from src.core.did import DID
        from src.core.exceptions import DIDValidationError
        print("âœ… 1. æ¨¡å—å¯¼å…¥æˆåŠŸ")
        return DID, DIDValidationError
    except ImportError as e:
        print(f"âŒ 1. æ¨¡å—å¯¼å…¥å¤±è´¥: {e}")
        return None, None

def test_did_creation(DID):
    """æµ‹è¯•DIDåˆ›å»º"""
    if not DID:
        return
    
    # åˆ›å»ºä¸åŒèº«ä»½çš„DID
    identities = {
        "å±…æ°‘": "resident",
        "ç»„ç»‡": "organization", 
        "è®¾å¤‡": "device",
        "æœåŠ¡": "service"
    }
    
    print("\nâœ… 2. åˆ›å»ºå„ç±»æ•°å­—èº«ä»½:")
    did_objects = {}
    for name, did_type in identities.items():
        did = DID.create(did_type=did_type)
        did_objects[name] = did
        print(f"   ğŸ”¹ {name}: {did}")
    
    return did_objects

def test_did_parsing(DID):
    """æµ‹è¯•DIDè§£æ"""
    print("\nâœ… 3. è§£æä¸éªŒè¯:")
    
    # æµ‹è¯•æœ‰æ•ˆDID
    valid_did = "did:xca:resident:test_resident_001"
    parsed = DID.parse(valid_did)
    print(f"   ğŸ”¹ è§£æ '{valid_did}'")
    print(f"     ç±»å‹: {parsed.did_type}")
    print(f"     æ ‡è¯†: {parsed.method_specific_id}")
    
    # æµ‹è¯•æ— æ•ˆDIDï¼ˆåº”æŠ›å‡ºå¼‚å¸¸ï¼‰
    print("   ğŸ”¹ éªŒè¯å¼‚å¸¸å¤„ç†...")
    invalid_cases = [
        "not_a_did",
        "did:wrong:method:123",
        "did:xca:invalid*type:123"
    ]
    
    for invalid in invalid_cases:
        try:
            DID.parse(invalid)
            print(f"     âŒ '{invalid}' åº”è¯¥å¤±è´¥ä½†é€šè¿‡äº†")
        except Exception:
            print(f"     âœ“ '{invalid}' æ­£ç¡®æ‹’ç»")

def test_did_document(DID):
    """æµ‹è¯•DIDæ–‡æ¡£ç”Ÿæˆ"""
    print("\nâœ… 4. ç”ŸæˆDIDæ–‡æ¡£:")
    
    did = DID.create(did_type="resident")
    doc = did.generate_document()
    
    required_fields = ["@context", "id", "created", "verificationMethod", "authentication"]
    missing = [field for field in required_fields if field not in doc]
    
    if not missing:
        print("   ğŸ”¹ æ–‡æ¡£åŒ…å«æ‰€æœ‰å¿…éœ€å­—æ®µ")
        print(f"     æ–‡æ¡£ID: {doc['id']}")
        print(f"     åˆ›å»ºæ—¶é—´: {doc['created']}")
        print(f"     éªŒè¯æ–¹æ³•: {len(doc['verificationMethod'])} ä¸ª")
    else:
        print(f"   âŒ ç¼ºå°‘å­—æ®µ: {missing}")

def test_did_features(DID):
    """æµ‹è¯•DIDé«˜çº§åŠŸèƒ½"""
    print("\nâœ… 5. é«˜çº§åŠŸèƒ½éªŒè¯:")
    
    # æµ‹è¯•ç›¸ç­‰æ€§
    did1 = DID.parse("did:xca:resident:same_id")
    did2 = DID.parse("did:xca:resident:same_id")
    did3 = DID.parse("did:xca:device:different")
    
    print(f"   ğŸ”¹ DIDç›¸ç­‰æ€§: {did1 == did2} (åº”è¯¥ä¸ºTrue)")
    print(f"   ğŸ”¹ DIDä¸ç›¸ç­‰: {did1 != did3} (åº”è¯¥ä¸ºTrue)")
    
    # æµ‹è¯•å“ˆå¸Œ
    print(f"   ğŸ”¹ å“ˆå¸Œä¸€è‡´æ€§: {hash(did1) == hash(did2)} (åº”è¯¥ä¸ºTrue)")

def main():
    """ä¸»éªŒè¯æµç¨‹"""
    DID, DIDValidationError = test_module_import()
    
    if not DID:
        print("\nâŒ éªŒè¯å¤±è´¥ï¼šæ— æ³•å¯¼å…¥æ ¸å¿ƒæ¨¡å—")
        print("\nå»ºè®®æ£€æŸ¥:")
        print("1. src/__init__.py æ˜¯å¦å­˜åœ¨")
        print("2. src/core/__init__.py æ˜¯å¦å­˜åœ¨")
        print("3. æ–‡ä»¶æƒé™æ˜¯å¦æ­£ç¡®")
        return False
    
    print("\n" + "=" * 60)
    print("å¼€å§‹å®Œæ•´åŠŸèƒ½éªŒè¯...")
    
    did_objects = test_did_creation(DID)
    test_did_parsing(DID)
    test_did_document(DID)
    test_did_features(DID)
    
    print("\n" + "=" * 60)
    print("ğŸ‰ éªŒè¯å®Œæˆï¼DIDæ¨¡å—æ‰€æœ‰æ ¸å¿ƒåŠŸèƒ½æ­£å¸¸ã€‚")
    print("\nä¸‹ä¸€æ­¥ï¼šå¼€å§‹æ„å»ºCVè´¦æˆ·ç³»ç»Ÿ")
    
    return True

if __name__ == "__main__":
    success = main()
    sys.exit(0 if success else 1)
```
